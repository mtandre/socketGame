<!doctype html>
<html>
  <head>
    <title>Socket Game</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
    <script src="/gc.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700' rel='stylesheet' type='text/css'>
    <style>
    html, body {margin:10px 0 0 0; padding:0; background:#2C3E50; color:#ECF0F1; font-family: 'Lato', sans-serif;}
    .container {margin:0 auto; width:96%; text-align:center;}
    .title {font-size:3em; color:#E74C3C; text-transform:capitalize;}
    .main button {display: block; border:none; outline:none; padding:15px 30px; color:#ECF0F1; font-size:2em;}
    .main button:hover {cursor: pointer;}
    button.top {background: #2980B9; margin: 30px auto;}
    button.bottom {background: #3498DB; margin: 0 auto;}
    .initial-hide {display:none;}
    input {text-transform:capitalize; margin: 0 0 20px 0; font-size: 2em; outline: none; border: none; width: 200px; color: #2C3E50; text-align: center;}
    .aa, .bb, .cc, .dd {margin:10px 0;}
    .disabled {background-color: #ECF0F1;}
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">Welcome</h1>
      <div class="main">

        <div class="welcome">
          <button class="top" data-route="host">New Game</button>
          <button class="bottom" data-route="player">Join Game</button>
        </div>

        <div class="name initial-hide">
          <input type="text" maxlength="8" id="username" placeholder="name" autocomplete="off">
          <button class="bottom" style="display:none;" id="continue">Ready!</button>
        </div>

        <div class="lobby initial-hide">
          <div class="message">Waiting on more players.<br>Other players: <span id="pc">0</span></div>
          <button class="top" style="display:none;" id="start">Play</button>
        </div>

        <div class="loading initial-hide">
          <div id="countDown"></div>
        </div>

        <div class="game initial-hide">
          <button class="aa disabled">A</button>
          <button class="bb disabled">B</button>
          <button class="cc disabled">C</button>
          <button class="dd disabled">D</button>
        </div>
      </div>
    </div>
  <script>
    var socket = io();

    var player = {id: 0, name: "", role: ""};
    var players = [];
    var playerCount = function() {return players.length};

    $(document).ready(function(){

      // welcome
      $('.welcome button').on("click", function() {
        player.role = $(this).data('route');
        $('.welcome').hide();
        $('.name').css({display: "block"});
      });

      // username
      $("#username").on('keyup',function () {
       if ($(this).val()) {
          $('#continue').show();
       }
       else {
          $('#continue').hide();
       }
      });

      // lobby
      $('#continue').on("click", function() {
        player.name = $("#username").val();
        $("#username").off('keyup');
        $('.name').hide();
        $('.title').text(player.name);
        $('.lobby').css({display: "block"});
        if(player.role === "host") {
          createGame();
        } else {
          joinGame();
        }
      });

      // game
      $('#start').on('click', startGame());

    });


    // create game - this user is the host
    function createGame() {

      // generate user id
      var d = new Date();
      var t = d.getTime().toString().slice(-7);
      player.id = t + "-" + player.name;
      players.push(player);

      // TODO: Connect to chromecast
      castMessage('Waiting for players');

      // listen for new players joining game
      socket.on('setup', function(data){

        //create new player
        var newPlayer = {id: data.id, name: data.name, role: "player"};
        players.push(newPlayer);
        $('#pc').text(playerCount() - 1);

        // confirm creation
        socket.emit('setup complete', {id: newPlayer.id, playerCount: playerCount()});

        // can we start?
        if (playerCount() > 1) {
          $('#start').fadeIn();
        } else {
          $('#start').fadeOut();
        }
      });
    }

    function startGame() {
      $('.lobby').hide();
      $('.loading').show();
      castMessage('Starting game');
    }

    function playGame() {

      /*
      for(var i = 0; i < 10; i++) {
        $('.title').text('Question ' + i);

      }
      */

    }


    // join game - this user is a player
    function joinGame() {

      // generate user id
      var d = new Date();
      var t = d.getTime().toString().slice(-7);
      player.id = t + "-" + player.name;

      // send player data
      socket.emit('setup', player);

      // confirm and update player count
      socket.on('setup complete', function(data){
        if(data.id === player.id) {
          $('#pc').text(data.playerCount - 1);
        }
      });

    }
  </script>
  <script src="/questions.js"></script>
  </body>
</html>
